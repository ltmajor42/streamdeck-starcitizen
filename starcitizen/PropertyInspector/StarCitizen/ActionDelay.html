<!-- File: PropertyInspector/StarCitizen/ActionDelay.html -->
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">

  <title>Mhwlng's Star Citizen</title>

  <link rel="stylesheet" href="../sdpi.css">
  <link rel="stylesheet" href="../jquery.highlight-within-textarea.css">

  <script src="../sdtools.common.js"></script>
  <script src="../jquery-3.3.1.min.js"></script>
  <script src="../jquery.highlight-within-textarea.js"></script>

  <style>
    .note { font-size: 11px; color: #999; line-height: 1.4; }
    .hidden { display: none; }
    .no-results { padding: 10px; color: #999; font-style: italic; text-align: center; }
  </style>
</head>

<body>
<div class="sdpi-wrapper">

  <div class="sdpi-item">
    <div class="sdpi-item-label">Search</div>
    <input type="text"
           class="sdpi-item-value"
           id="functionSearch"
           placeholder="Type to search functions..."
           autocomplete="off">
    <div class="sdpi-item-value" id="searchResults"
         style="font-size: 11px; color: #999; margin-top: 4px;"></div>
  </div>

  <div class="sdpi-item">
    <div class="sdpi-item-label">Function</div>
    <select class="sdpi-item-value select sdProperty"
            id="function"
            oninput="setSettings()"
            onchange="setSettings()">
      <option value="">Loading Star Citizen functions...</option>
    </select>
  </div>

  <div class="sdpi-item">
    <div class="sdpi-item-label">Execute after (ms)</div>
    <input type="number"
           class="sdpi-item-value sdProperty"
           id="executionDelayMs"
           min="100"
           max="5000"
           step="10"
           oninput="setSettings()"
           onchange="setSettings()">
  </div>

  <div class="sdpi-item">
    <div class="sdpi-item-label">Blink rate (ms)</div>
    <input type="number"
           class="sdpi-item-value sdProperty"
           id="blinkRateMs"
           min="100"
           max="1000"
           step="10"
           oninput="setSettings()"
           onchange="setSettings()">
  </div>

  <div class="sdpi-item">
    <div class="sdpi-item-label">Confirm state (ms)</div>
    <input type="number"
           class="sdpi-item-value sdProperty"
           id="confirmationDurationMs"
           min="100"
           max="3000"
           step="10"
           oninput="setSettings()"
           onchange="setSettings()">
  </div>

  <div class="sdpi-item">
    <div class="sdpi-item-label">Tap again to cancel</div>
    <input type="checkbox"
           class="sdpi-item-value sdProperty"
           id="holdToCancel"
           oninput="setSettings()"
           onchange="setSettings()">
  </div>

  <div class="sdpi-item" id="dvClickSound">
    <div class="sdpi-item-label">Sound</div>
    <div class="sdpi-item-group file">
      <input class="sdpi-item-value sdProperty sdFile"
             type="file"
             id="clickSound"
             accept=".wav"
             oninput="setSettings(); updateClearSoundVisibility();"
             onchange="setSettings(); updateClearSoundVisibility();">
      <label class="sdpi-file-info" id="clickSoundFilename">No file...</label>
      <label class="sdpi-file-label" for="clickSound">Choose file...</label>
    </div>
  </div>

  <div class="sdpi-item hidden" id="dvClearSound">
    <div class="sdpi-item-label"></div>
    <button class="sdpi-item-value" onclick="clearClickSound()">Clear sound</button>
  </div>

  <div class="sdpi-item no-results hidden" id="noResults">
    No functions match your search.
  </div>

  <div class="sdpi-item">
    <div class="sdpi-item-label"></div>
    <div class="sdpi-item-value note">
      Pending blinks by toggling Stream Deck State 0 ↔ State 1. Make sure your State 0 and State 1 images are different.
    </div>
  </div>

</div>

<script>
  let allOptions = [];
  let functionsLoaded = false;
  let savedFunctionValue = null;

  const originalLoadConfiguration = loadConfiguration;
  loadConfiguration = function (payload) {
    if (payload && payload.function !== undefined) {
      savedFunctionValue = payload.function;
    }
    originalLoadConfiguration(payload);

    if (functionsLoaded && savedFunctionValue) {
      const sel = document.getElementById('function');
      if (sel && sel.value !== savedFunctionValue) {
        sel.value = savedFunctionValue;
      }
    }

    updateClearSoundVisibility();
  };

  function populateDropdown(functionsData) {
    const select = document.getElementById('function');
    select.innerHTML = '';
    allOptions = [];

    const empty = document.createElement('option');
    empty.value = '';
    empty.textContent = '-- Select a function --';
    select.appendChild(empty);

    functionsData.forEach(group => {
      const optgroup = document.createElement('optgroup');
      optgroup.label = group.label;

      group.options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt.value;
        option.textContent = opt.text;
        option.dataset.search = opt.searchText || opt.text.toLowerCase();

        optgroup.appendChild(option);

        allOptions.push({
          option,
          optgroup,
          search: option.dataset.search
        });
      });

      if (optgroup.children.length > 0) {
        select.appendChild(optgroup);
      }
    });

    functionsLoaded = true;

    if (savedFunctionValue) {
      select.value = savedFunctionValue;
    }

    filterOptions();
  }

  function filterOptions() {
    const term = document.getElementById('functionSearch').value.toLowerCase().trim();
    const noResults = document.getElementById('noResults');
    const searchResults = document.getElementById('searchResults');

    let visibleGroups = 0;

    allOptions.forEach(o => {
      const visible = !term || o.search.includes(term);
      o.option.style.display = visible ? '' : 'none';
    });

    document.querySelectorAll('#function optgroup').forEach(group => {
      const hasVisible = Array.from(group.children).some(o => o.style.display !== 'none');
      group.style.display = hasVisible ? '' : 'none';
      if (hasVisible) visibleGroups++;
    });

    const anyVisibleOption = allOptions.some(o => o.option.style.display !== 'none');

    noResults.classList.toggle('hidden', anyVisibleOption || !term);
    searchResults.textContent = term ? `Found ${visibleGroups} group${visibleGroups !== 1 ? 's' : ''}` : '';
  }

  function updateClearSoundVisibility() {
    const input = document.getElementById('clickSound');
    const clearBtn = document.getElementById('dvClearSound');
    if (!input || !clearBtn) return;
    clearBtn.classList.toggle('hidden', !input.value);
  }

  function clearClickSound() {
    const input = document.getElementById('clickSound');
    const label = document.getElementById('clickSoundFilename');

    if (input) input.value = '';
    if (label) label.textContent = 'No file...';

    setSettings({ clickSound: '' });
    updateClearSoundVisibility();
  }

  document.addEventListener('websocketCreate', function () {
    const originalOnMessage = websocket.onmessage;
    websocket.onmessage = function (evt) {
      const jsonObj = JSON.parse(evt.data);
      if (jsonObj.event === 'sendToPropertyInspector'
          && jsonObj.payload
          && jsonObj.payload.functionsLoaded) {
        populateDropdown(jsonObj.payload.functions);
      }
      if (originalOnMessage) {
        originalOnMessage.call(this, evt);
      }
    };
  });

  document.addEventListener('DOMContentLoaded', function () {
    document.getElementById('functionSearch')
      .addEventListener('input', function () {
        clearTimeout(this.searchTimeout);
        this.searchTimeout = setTimeout(filterOptions, 150);
      });

    updateClearSoundVisibility();
  });
</script>

</body>
</html>
