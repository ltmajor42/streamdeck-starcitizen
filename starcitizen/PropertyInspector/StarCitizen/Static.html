<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no,minimal-ui,viewport-fit=cover">
    <meta name=apple-mobile-web-app-capable content=yes>
    <meta name=apple-mobile-web-app-status-bar-style content=black>
    <title>Mhwlng's Star Citizen</title>
    <link rel="stylesheet" href="../sdpi.css">
    <link rel="stylesheet" href="../jquery.highlight-within-textarea.css">
    <script src="../sdtools.common.js"></script>
    <script src="../jquery-3.3.1.min.js"></script>
    <script src="../jquery.highlight-within-textarea.js"></script>
    <style>
        .no-results {
            padding: 10px;
            color: #999;
            font-style: italic;
            text-align: center;
        }
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="sdpi-wrapper">

        <div class="sdpi-item">
            <div class="sdpi-item-label">Search</div>
            <input type="text" class="sdpi-item-value" id="functionSearch" placeholder="Type to search functions..." autocomplete="off">
            <div class="sdpi-item-value" id="searchResults" style="font-size: 11px; color: #999; margin-top: 4px;"></div>
        </div>

        <div class="sdpi-item">
            <div class="sdpi-item-label">Function</div>
            <select class="sdpi-item-value select sdProperty" id="function" oninput="setSettings()">
                <option value="" class="loading-indicator">Loading Star Citizen functions...</option>
            </select>
        </div>

        <div class="sdpi-item" id="dvClickSound">
            <div class="sdpi-item-label" onclick="clearFileName('clickSound');">Sound</div>
            <div class="sdpi-item-group file" id="filepickergroup1">
                <input class="sdpi-item-value sdProperty sdFile" type="file" id="clickSound" accept=".wav" oninput="setSettings()">
                <label class="sdpi-file-info " for="clickSound" id="clickSoundFilename">No file...</label>
                <label class="sdpi-file-label" for="clickSound">Choose file...</label>
            </div>
        </div>

        <div class="sdpi-item no-results hidden" id="noResults">No functions match your search.</div>

    </div>

    <script>
        // Store all options for search functionality
        let allOptions = [];
        let functionsLoaded = false;
        let savedFunctionValue = null;

        // Override loadConfiguration to handle function field specially
        const originalLoadConfiguration = loadConfiguration;
        loadConfiguration = function(payload) {
            console.log('Custom loadConfiguration called');
            
            // Save the function value if present
            if (payload && payload.function) {
                savedFunctionValue = payload.function;
                console.log('Saved function value for later restoration:', savedFunctionValue);
                
                // If dropdown is already loaded, set it now
                if (functionsLoaded) {
                    const functionSelect = document.getElementById('function');
                    if (functionSelect) {
                        functionSelect.value = savedFunctionValue;
                        console.log('Immediately set function value:', savedFunctionValue);
                    }
                }
                
                // Remove function from payload so original loadConfiguration doesn't try to set it
                const payloadCopy = Object.assign({}, payload);
                delete payloadCopy.function;
                originalLoadConfiguration(payloadCopy);
            } else {
                // No function in payload, call original as-is
                originalLoadConfiguration(payload);
            }
        };

        // Populate dropdown with functions data from the plugin
        function populateDropdown(functionsData) {
            console.log('Populating dropdown with', functionsData.length, 'groups');
            
            const functionSelect = document.getElementById('function');
            
            // Clear existing options
            functionSelect.innerHTML = '';
            allOptions = [];
            
            // Add empty option
            const emptyOption = document.createElement('option');
            emptyOption.value = '';
            emptyOption.textContent = '-- Select a function --';
            functionSelect.appendChild(emptyOption);
            
            // Add option groups
            functionsData.forEach(group => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = group.label;
                optgroup.setAttribute('data-category', group.label.toLowerCase().replace(/ /g, '-'));
                
                group.options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    option.setAttribute('data-binding-type', opt.bindingType || '');
                    option.setAttribute('data-search', opt.searchText || opt.text.toLowerCase());
                    
                    optgroup.appendChild(option);
                    
                    // Store for search functionality
                    allOptions.push({
                        element: option,
                        optgroup: optgroup,
                        text: opt.text.toLowerCase(),
                        searchText: opt.searchText || opt.text.toLowerCase(),
                        value: opt.value
                    });
                });
                
                functionSelect.appendChild(optgroup);
            });
            
            functionsLoaded = true;
            console.log('Dropdown populated with', allOptions.length, 'total options');
            
            // Restore saved value if any
            if (savedFunctionValue) {
                functionSelect.value = savedFunctionValue;
                console.log('Restored saved function value after population:', savedFunctionValue);
            }
        }

        // Filter options based on search
        function filterOptions() {
            if (!functionsLoaded) return;
            
            const searchInput = document.getElementById('functionSearch');
            const functionSelect = document.getElementById('function');
            const noResults = document.getElementById('noResults');
            const searchResults = document.getElementById('searchResults');
            
            const searchTerm = searchInput.value.toLowerCase().trim();
            let visibleCount = 0;

            allOptions.forEach(option => {
                const isVisible = !searchTerm ||
                    option.searchText.includes(searchTerm) ||
                    option.text.includes(searchTerm);

                if (isVisible) {
                    option.element.style.display = '';
                    option.optgroup.style.display = '';
                    visibleCount++;
                } else {
                    option.element.style.display = 'none';
                }
            });

            // Hide empty optgroups
            functionSelect.querySelectorAll('optgroup').forEach(optgroup => {
                const hasVisibleOptions = Array.from(optgroup.querySelectorAll('option')).some(option =>
                    option.style.display !== 'none'
                );
                optgroup.style.display = hasVisibleOptions ? '' : 'none';
            });

            // Show/hide no results message
            noResults.classList.toggle('hidden', visibleCount > 0);
            
            // Update result counter
            if (searchTerm) {
                searchResults.textContent = `Found ${visibleCount} function${visibleCount !== 1 ? 's' : ''}`;
                // Auto-open the dropdown when searching
                functionSelect.focus();
                functionSelect.size = 10; // Show multiple options at once
            } else {
                searchResults.textContent = '';
                functionSelect.size = 1; // Back to normal dropdown
            }

            console.log('Search filtered to', visibleCount, 'visible options');
        }

        // Override websocket message handler to capture function data
        document.addEventListener('websocketCreate', function() {
            console.log('Websocket created, setting up message interceptor');
            
            const originalOnMessage = websocket.onmessage;
            websocket.onmessage = function(evt) {
                var jsonObj = JSON.parse(evt.data);
                
                // Intercept our custom function data
                if (jsonObj.event === 'sendToPropertyInspector' && jsonObj.payload && jsonObj.payload.functionsLoaded) {
                    console.log('Received functions data, populating dropdown');
                    populateDropdown(jsonObj.payload.functions);
                }
                
                // Always call original handler to let SDK do its thing
                if (originalOnMessage) {
                    originalOnMessage.call(this, evt);
                }
            };
        });

        // Search functionality initialization
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('functionSearch');
            const functionSelect = document.getElementById('function');
            const searchResults = document.getElementById('searchResults');

            // Event listeners
            searchInput.addEventListener('input', function() {
                // Debounce search for better performance
                clearTimeout(searchInput.searchTimeout);
                searchInput.searchTimeout = setTimeout(filterOptions, 150);
            });

            // Clear search after selection
            functionSelect.addEventListener('change', function() {
                if (functionSelect.value) {
                    // User selected a function, clear the search
                    searchInput.value = '';
                    searchResults.textContent = '';
                    functionSelect.size = 1; // Back to normal dropdown
                    
                    // Reset all options to visible
                    allOptions.forEach(option => {
                        option.element.style.display = '';
                        option.optgroup.style.display = '';
                    });
                    
                    console.log('Search cleared after selection');
                }
            });

            console.log('Static.html initialized, waiting for functions data...');
        });
    </script>
</body>
</html>
